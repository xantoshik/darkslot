<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DarkSlot Roulette</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #1e1e2f, #3b3b5b);
            color: #fff;
        }
        #roulette {
            overflow: hidden;
            height: 120px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
            margin-bottom: 20px;
            white-space: nowrap;
            animation: preview-spin 10s linear infinite;
        }
        @keyframes preview-spin {
            from { transform: translateX(0); }
            to { transform: translateX(-50%); }
        }
        .item {
            display: inline-block;
            width: 100px;
            height: 100px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin: 10px;
            background-color: transparent;
            border: none;
            outline: none;
        }
        #large-item {
            display: none;
            width: 200px;
            height: 200px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background-color: transparent;
            border-radius: 10px;
            box-shadow: 0 0 30px #ffd700;
            margin: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            background-color: #ffd700;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            color: #1e1e2f;
        }
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        #result {
            font-size: 18px;
            margin: 10px 0;
            text-align: center;
        }
        #timer {
            font-size: 16px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div id="roulette"></div>
    <div id="large-item"></div>
    <div id="result"></div>
    <div id="timer"></div>
    <button id="play-free">Бесплатный спин</button>
    <button id="play-paid">Платный спин (25 звёзд)</button>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const rouletteDiv = document.getElementById('roulette');
        const largeItem = document.getElementById('large-item');
        const resultDiv = document.getElementById('result');
        const timerDiv = document.getElementById('timer');
        const playFree = document.getElementById('play-free');
        const playPaid = document.getElementById('play-paid');

        let freeSpinAvailable = false;

        const urlParams = new URLSearchParams(window.location.search);
        const lang = urlParams.get('lang') || 'ru';
        const agree = urlParams.get('agree') === 'true';

        const texts = {
            ru: {
                title: "Подтверждение",
                paid: "Прокрутить рулетку за 25 звёзд?",
                confirm: "Подтвердить",
                result: "Вы выиграли {item}! Приз: {prize} звёзд",
                sell: "ПРОДАТЬ",
                timer: "Следующий спин через: {time}",
                nothing: "Ничего",
                bear: "Медведь",
                rose: "Роза",
                rocket: "Ракета",
                diamond: "Алмаз"
            },
            en: {
                title: "Confirmation",
                paid: "Spin the roulette for 25 stars?",
                confirm: "Confirm",
                result: "You won {item}! Prize: {prize} stars",
                sell: "SELL",
                timer: "Next spin in: {time}",
                nothing: "Nothing",
                bear: "Bear",
                rose: "Rose",
                rocket: "Rocket",
                diamond: "Diamond"
            }
        }[lang];

        function initPreview() {
            console.log('Инициализация превью рулетки');
            const items = ['nothing', 'bear', 'rose', 'rocket', 'diamond'];
            let htmlItems = [];
            for (let i = 0; i < 20; i++) {
                const item = items[Math.floor(Math.random() * items.length)];
                console.log(`Добавление элемента: images/${item}.png`);
                htmlItems.push(`<div class="item" style="background-image: url('images/${item}.png');"></div>`);
            }
            rouletteDiv.innerHTML = htmlItems.join('');
            console.log('Текущий transform:', rouletteDiv.style.transform);
        }

        function spin(item, prize) {
            console.log(`Прокрутка, результат: ${item}, приз: ${prize}`);
            rouletteDiv.style.animation = 'none';
            void rouletteDiv.offsetWidth;
            rouletteDiv.style.transition = 'transform 5s ease-out';
            rouletteDiv.style.transform = 'translateX(-80%)';
            playFree.disabled = true;
            playPaid.disabled = true;
            setTimeout(() => {
                largeItem.style.backgroundImage = `url('images/${item}.png')`;
                largeItem.style.display = 'block';
                resultDiv.textContent = texts.result.replace('{item}', texts[item]).replace('{prize}', prize);
                if (item !== 'nothing') {
                    tg.MainButton.setText(texts.sell);
                    tg.MainButton.show();
                } else {
                    setTimeout(() => {
                        largeItem.style.display = 'none';
                        resultDiv.textContent = '';
                        rouletteDiv.style.transition = 'none';
                        rouletteDiv.style.transform = 'translateX(0)';
                        rouletteDiv.style.animation = 'preview-spin 10s linear infinite';
                        playFree.disabled = false;
                        playPaid.disabled = false;
                    }, 2000);
                }
            }, 5000);
        }

        function checkFreeSpin() {
            console.log('Проверка фриспина');
            tg.sendData(JSON.stringify({ action: 'check_free' }));
        }

        function updateTimer(timeLeft) {
            if (!timeLeft && freeSpinAvailable) {
                playFree.style.display = 'block';
                playPaid.style.display = 'none';
                timerDiv.textContent = '';
                return;
            }
            const seconds = Math.floor(timeLeft / 1000);
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            timerDiv.textContent = texts.timer.replace('{time}', `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`);
            playFree.style.display = 'none';
            playPaid.style.display = 'block';
            setTimeout(checkFreeSpin, 1000);
        }

        tg.onEvent('webAppData', data => {
            console.log('Получены данные WebApp:', data);
            const parsed = JSON.parse(data);
            if (parsed.action === 'check_free') {
                freeSpinAvailable = parsed.free_available;
                updateTimer(parsed.time_left ? new Date().getTime() + parsed.time_left.split(':').reduce((acc, t, i) => acc + t * [3600, 60, 1][i] * 1000, 0) - new Date().getTime() : 0);
            } else if (parsed.action === 'spin') {
                spin(parsed.item, parsed.prize);
            }
        });

        tg.onEvent('mainButtonClicked', () => {
            console.log('Клик по главной кнопке');
            const item = largeItem.style.backgroundImage.match(/images\/(.+)\.png/)[1];
            tg.sendData(JSON.stringify({ action: 'sell', item }));
            tg.MainButton.hide();
            largeItem.style.display = 'none';
            resultDiv.textContent = '';
            rouletteDiv.style.transition = 'none';
            rouletteDiv.style.transform = 'translateX(0)';
            rouletteDiv.style.animation = 'preview-spin 10s linear infinite';
            playFree.disabled = false;
            playPaid.disabled = false;
        });

        playFree.addEventListener('click', () => {
            console.log('Клик по бесплатному спину');
            tg.sendData(JSON.stringify({ action: 'spin', paid: false }));
        });

        playPaid.addEventListener('click', () => {
            console.log('Клик по платному спину');
            tg.showPopup({
                title: texts.title,
                message: texts.paid,
                buttons: [
                    { id: 'confirm', type: 'ok', text: texts.confirm },
                    { type: 'cancel' }
                ]
            }, buttonId => {
                console.log('Попап платного спина, выбор:', buttonId);
                if (buttonId === 'confirm') {
                    console.log('Отправка инвойса');
                    tg.sendInvoice({
                        title: 'Платный спин',
                        description: 'Прокрутка рулетки за 25 звёзд',
                        payload: JSON.stringify({ action: 'spin', paid: true }),
                        provider_token: 'YOUR_PROVIDER_TOKEN', // Замени на токен от @BotFather
                        currency: 'XTR',
                        prices: [{ label: 'Спин', amount: 25 }],
                        start_parameter: 'spin-paid'
                    });
                }
            });
        });

        if (agree) {
            tg.sendData(JSON.stringify({ action: 'agree' }));
        }

        initPreview();
        checkFreeSpin();
    </script>
</body>
</html>
